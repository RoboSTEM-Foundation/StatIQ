name: Update Team Master List

on:
  schedule:
    # Run every Sunday at 2 AM UTC (weekly)
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-team-master-list.yml'

jobs:
  update-team-list:
    runs-on: ubuntu-latest
    name: Update Team Master List
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TEAMLIST_TOKEN }}
          repository: Lavadeg31/teamlist
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm init -y
          npm install axios

      - name: Create team scraper script
        run: |
          cat > scrape-teams.js << 'EOF'
          const axios = require('axios');
          const fs = require('fs');
          const path = require('path');

          // RobotEvents API configuration
          const ROBOTEVENTS_API_BASE = 'https://www.robotevents.com/api/v2';
          const API_KEY = process.env.ROBOTEVENTS_API_KEY;

          // VEX IQ program ID and grade levels
          const VEX_IQ_PROGRAM_ID = 41; // VEX IQ Challenge program ID
          const VEX_IQ_GRADES = ['Elementary School', 'Middle School'];

          // Rate limiting
          const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

          // Make API request with retry logic
          async function makeRequest(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
              try {
                const response = await axios.get(url, {
                  headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'User-Agent': 'StatIQ-TeamScraper/1.0'
                  },
                  timeout: 30000
                });
                return response.data;
              } catch (error) {
                console.log(`Attempt ${i + 1} failed: ${error.message}`);
                if (i === retries - 1) throw error;
                await delay(2000 * (i + 1)); // Exponential backoff
              }
            }
          }

          // Get all teams for a grade level
          async function getTeamsForGrade(grade) {
            console.log(`\nüîç Scraping teams for ${grade}...`);
            const allTeams = [];
            let page = 1;
            const perPage = 250; // Max per page

            while (true) {
              try {
                const url = `${ROBOTEVENTS_API_BASE}/teams?program[]=${VEX_IQ_PROGRAM_ID}&grade[]=${encodeURIComponent(grade)}&per_page=${perPage}&page=${page}`;
                console.log(`  üìÑ Fetching page ${page}...`);
                console.log(`  üîó URL: ${url}`);
                
                const data = await makeRequest(url);
                
                if (!data.data || data.data.length === 0) {
                  console.log(`  ‚úÖ No more teams found on page ${page}`);
                  break;
                }

                console.log(`  üìä Total teams on page: ${data.data.length}`);
                
                // Log all programs found
                const programs = [...new Set(data.data.map(team => team.program?.name).filter(Boolean))];
                console.log(`  üè∑Ô∏è  Programs found: ${programs.join(', ')}`);

                // All teams should be VEX IQ since we filtered by program ID
                allTeams.push(...data.data);
                console.log(`  üìä Found ${data.data.length} VEX IQ teams on page ${page} (${allTeams.length} total)`);

                // Check if we've reached the last page
                if (data.data.length < perPage) {
                  console.log(`  ‚úÖ Reached last page`);
                  break;
                }

                page++;
                await delay(1000); // Rate limiting
              } catch (error) {
                console.error(`  ‚ùå Error fetching page ${page}:`, error.message);
                break;
              }
            }

            return allTeams;
          }

          // Process team data (no additional API calls needed)
          function processTeamData(team) {
            return {
              id: team.id,
              number: team.number,
              name: team.team_name,
              robotName: team.robot_name,
              organization: team.organization,
              location: team.location?.city + ', ' + team.location?.region + ', ' + team.location?.country,
              city: team.location?.city,
              region: team.location?.region,
              country: team.location?.country,
              postcode: team.location?.postcode,
              coordinates: team.location?.coordinates,
              grade: team.grade,
              lastUpdated: new Date().toISOString()
            };
          }

          // Test API connection and get available seasons
          async function testApiConnection() {
            console.log('üîç Testing API connection...');
            try {
              const seasonsUrl = `${ROBOTEVENTS_API_BASE}/seasons`;
              console.log(`üîó Testing URL: ${seasonsUrl}`);
              const seasonsData = await makeRequest(seasonsUrl);
              
              console.log('üìã Available seasons:');
              seasonsData.data.forEach(season => {
                if (season.program && season.program.name === 'VEX IQ Challenge') {
                  console.log(`  - ID: ${season.id}, Name: ${season.name}`);
                }
              });
              
              return true;
            } catch (error) {
              console.error('‚ùå API connection test failed:', error.message);
              return false;
            }
          }

          // Main scraping function
          async function scrapeAllTeams() {
            console.log('üöÄ Starting team master list update...');
            console.log(`üìÖ Timestamp: ${new Date().toISOString()}`);
            
            // Test API connection first
            const apiWorking = await testApiConnection();
            if (!apiWorking) {
              throw new Error('API connection test failed');
            }
            
            const masterTeamList = {
              metadata: {
                lastUpdated: new Date().toISOString(),
                totalTeams: 0,
                grades: VEX_IQ_GRADES.map(g => ({ grade: g, teamCount: 0 })),
                apiVersion: '2.0'
              },
              teams: []
            };

            // Scrape teams for each grade level
            for (const grade of VEX_IQ_GRADES) {
              try {
                const teams = await getTeamsForGrade(grade);
                
                // Process team data (no additional API calls)
                console.log(`  üîÑ Processing ${teams.length} teams...`);
                const processedTeams = teams.map(team => processTeamData(team));

                masterTeamList.teams.push(...processedTeams);
                masterTeamList.metadata.grades.find(g => g.grade === grade).teamCount = processedTeams.length;
                
                console.log(`  ‚úÖ Completed ${grade}: ${processedTeams.length} teams`);
                await delay(1000); // Short pause between grades
              } catch (error) {
                console.error(`  ‚ùå Error processing grade ${grade}:`, error.message);
              }
            }

            // Remove duplicates (teams that appear in multiple grades)
            const uniqueTeams = new Map();
            masterTeamList.teams.forEach(team => {
              if (!uniqueTeams.has(team.number) || 
                  new Date(team.lastUpdated) > new Date(uniqueTeams.get(team.number).lastUpdated)) {
                uniqueTeams.set(team.number, team);
              }
            });

            masterTeamList.teams = Array.from(uniqueTeams.values());
            masterTeamList.metadata.totalTeams = masterTeamList.teams.length;

            // Sort teams by number
            masterTeamList.teams.sort((a, b) => {
              const numA = parseInt(a.number) || 0;
              const numB = parseInt(b.number) || 0;
              return numA - numB;
            });

            return masterTeamList;
          }

          // Save data to files
          async function saveTeamData(teamData) {
            const outputDir = path.join(process.cwd(), 'lib', 'data');
            if (!fs.existsSync(outputDir)) {
              fs.mkdirSync(outputDir, { recursive: true });
            }

            // Save full data as JSON
            const fullDataPath = path.join(outputDir, 'master_team_list.json');
            fs.writeFileSync(fullDataPath, JSON.stringify(teamData, null, 2));
            console.log(`üíæ Saved full data to ${fullDataPath}`);

            // Save lightweight version for quick lookups
            const lightweightData = {
              metadata: teamData.metadata,
              teams: teamData.teams.map(team => ({
                id: team.id,
                number: team.number,
                name: team.name,
                robotName: team.robotName,
                organization: team.organization,
                location: team.location,
                city: team.city,
                region: team.region,
                country: team.country,
                postcode: team.postcode,
                coordinates: team.coordinates,
                grade: team.grade,
                lastUpdated: team.lastUpdated
              }))
            };

            const lightweightPath = path.join(outputDir, 'team_lookup.json');
            fs.writeFileSync(lightweightPath, JSON.stringify(lightweightData, null, 2));
            console.log(`üíæ Saved lightweight data to ${lightweightPath}`);

            // Generate Dart constants file
            const dartConstants = '// Auto-generated team data - Updated ' + teamData.metadata.lastUpdated + '\n' +
              '// Total teams: ' + teamData.metadata.totalTeams + '\n\n' +
              'class TeamMasterList {\n' +
              '  static const String lastUpdated = \'' + teamData.metadata.lastUpdated + '\';\n' +
              '  static const int totalTeams = ' + teamData.metadata.totalTeams + ';\n' +
              '  \n' +
              '  static const Map<String, dynamic> metadata = {\n' +
              '    \'lastUpdated\': \'' + teamData.metadata.lastUpdated + '\',\n' +
              '    \'totalTeams\': ' + teamData.metadata.totalTeams + ',\n' +
              '    \'grades\': ' + JSON.stringify(teamData.metadata.grades) + ',\n' +
              '    \'apiVersion\': \'' + teamData.metadata.apiVersion + '\',\n' +
              '  };\n' +
              '  \n' +
              '  // Team lookup by number\n' +
              '  static const Map<String, dynamic> teamLookup = {\n' +
              teamData.teams.map(team => 
                '    \'' + team.number + '\': {\n' +
                '      \'id\': ' + team.id + ',\n' +
                '      \'number\': \'' + team.number + '\',\n' +
                '      \'name\': \'' + (team.name || '').replace(/'/g, "\\'") + '\',\n' +
                '      \'robotName\': \'' + (team.robotName || '').replace(/'/g, "\\'") + '\',\n' +
                '      \'organization\': \'' + (team.organization || '').replace(/'/g, "\\'") + '\',\n' +
                '      \'location\': \'' + (team.location || '').replace(/'/g, "\\'") + '\',\n' +
                '      \'city\': \'' + (team.city || '').replace(/'/g, "\\'") + '\',\n' +
                '      \'region\': \'' + (team.region || '').replace(/'/g, "\\'") + '\',\n' +
                '      \'country\': \'' + (team.country || '').replace(/'/g, "\\'") + '\',\n' +
                '      \'postcode\': \'' + (team.postcode || '') + '\',\n' +
                '      \'grade\': \'' + (team.grade || '') + '\',\n' +
                '      \'lastUpdated\': \'' + team.lastUpdated + '\',\n' +
                '    }'
              ).join(',\n') + '\n' +
              '  };\n' +
              '}\n';

            const dartPath = path.join(outputDir, 'team_master_list.dart');
            fs.writeFileSync(dartPath, dartConstants);
            console.log(`üíæ Saved Dart constants to ${dartPath}`);

            // Generate summary report
            const summary = '# Team Master List Update Report\n\n' +
              '**Generated:** ' + teamData.metadata.lastUpdated + '\n' +
              '**Total Teams:** ' + teamData.metadata.totalTeams + '\n\n' +
              '## Grade Breakdown:\n' +
              teamData.metadata.grades.map(g => '- **' + g.grade + '**: ' + g.teamCount + ' teams').join('\n') + '\n\n' +
              '## Top 10 Teams by Number:\n' +
              teamData.teams.slice(0, 10).map(team => '- ' + team.number + ': ' + (team.name || 'Unnamed') + ' (' + (team.organization || 'No Organization') + ')').join('\n') + '\n\n' +
              '## Files Generated:\n' +
              '- `lib/data/master_team_list.json` - Complete team data with skills, events, awards\n' +
              '- `lib/data/team_lookup.json` - Lightweight team lookup data\n' +
              '- `lib/data/team_master_list.dart` - Dart constants for app integration\n\n' +
              '## Usage in App:\n' +
              '```dart\n' +
              'import \'package:stat_iq/data/team_master_list.dart\';\n\n' +
              '// Get team info\n' +
              'final teamInfo = TeamMasterList.teamLookup[\'12345A\'];\n' +
              'if (teamInfo != null) {\n' +
              '  print(\'Team: \${teamInfo[\'name\']}\');\n' +
              '  print(\'Organization: \${teamInfo[\'organization\']}\');\n' +
              '  print(\'Location: \${teamInfo[\'location\']}\');\n' +
              '}\n' +
              '```\n';

            const summaryPath = path.join(outputDir, 'TEAM_UPDATE_REPORT.md');
            fs.writeFileSync(summaryPath, summary);
            console.log(`üíæ Saved summary report to ${summaryPath}`);
          }

          // Main execution
          async function main() {
            try {
              if (!API_KEY) {
                throw new Error('ROBOTEVENTS_API_KEY environment variable is required');
              }

              const teamData = await scrapeAllTeams();
              await saveTeamData(teamData);
              
              console.log('\nüéâ Team master list update completed successfully!');
              console.log(`üìä Total teams processed: ${teamData.metadata.totalTeams}`);
              console.log(`üìÖ Last updated: ${teamData.metadata.lastUpdated}`);
              
              // Set output for GitHub Actions
              if (process.env.GITHUB_OUTPUT) {
                fs.appendFileSync(process.env.GITHUB_OUTPUT, `total_teams=${teamData.metadata.totalTeams}\n`);
                fs.appendFileSync(process.env.GITHUB_OUTPUT, `last_updated=${teamData.metadata.lastUpdated}\n`);
              }
            } catch (error) {
              console.error('‚ùå Fatal error:', error);
              process.exit(1);
            }
          }

          main();
          EOF

      - name: Run team scraper
        env:
          ROBOTEVENTS_API_KEY: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiIzIiwianRpIjoiNTJhYzMzZjc3NmQwMzg1NjA2ZjM5YzZlZjNlNjQ5OWI5Y2JkYzNjZmY3YTM2ZjU4NzMzYjU4MmIxZjZhYzY4ZGMyODVlYmRhNDhlMzM2M2MiLCJpYXQiOjE3NDg0ODM2MjIuNDQ3MjgyMSwibmJmIjoxNzQ4NDgzNjIyLjQ0NzI4NCwiZXhwIjoyNjk1MTY4NDIyLjQ0MTMzNjIsInN1YiI6IjEzOTU1OCIsInNjb3BlcyI6W119.Lk119Jqi64rRqvCLSCyS_Rc72Ee-oVjxRS9FB8Qs3Q3_DaXm7B2YT_BUEgNGMyRBLHXTeOeTWUAXoqt-7p41LU7ZJ8Q-rFRXDomyh4IOooTS04HjxdOgE_UCncXGwctwkh_E31p2Bw1u6K4BnJ0vZJLpK-uydOXteLLb4-YCKnBQM5PiZrpSZMSbuUyKNVfg_cKlofTsq_2aiPIWR-e0AeT-zEF5uJzGbpFOGJU1Jz2RejTFb26PUq6KcaPxuppu1OTnhFYBaPwZZBtjpHdr24lWyG6Pb-GtaV4Sn0l5_fSo-eoXT_bAMx1vgIqXoS03aja1IRLdIYlMQR7eMlXB5eAJBMgA0AzIRFg8fm4IFmTDHHxykyQmDnKUeFKE50jYiYDJjEx5MDCuso1tHQaEQt38ucL_t7UegPaoGYa4MkhPUQZIieftvskTopi7jsy78IfF76pRI6OPZOjqjbdDfpFhtz2zCxypx-x3qNq1hlDNOf0szkozxQxlHpWx2KMhfAUAwJk3IHA0_o2RTCk0r4vAMP_8RKrRodkIS93cqyB_r9uZLIAHyvMKOOg2Du8qKQBKY1lK8Zke68WidiP6Ggl_iQxItAEkfxgVZ0ElK9N6fPzWJ94hvJCnbn0EcG9CHAlOnDHUfr74ZFaGWlQGx_EsWQxX1l3ZBmmp3AmmwQo"
        run: node scrape-teams.js

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain lib/data/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù Team data has been updated"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes to team data"
          fi

      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git remote set-url origin https://${{ secrets.TEAMLIST_TOKEN }}@github.com/Lavadeg31/teamlist.git
          git add lib/data/
          git commit -m "ü§ñ Auto-update team master list

          - Total teams: ${{ steps.run-team-scraper.outputs.total_teams || 'Unknown' }}
          - Last updated: ${{ steps.run-team-scraper.outputs.last_updated || 'Unknown' }}
          - Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          This commit was automatically generated by the team master list update workflow."

      - name: Push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: git push

      - name: Create summary
        run: |
          echo "## ü§ñ Team Master List Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Total Teams:** ${{ steps.run-team-scraper.outputs.total_teams || 'Unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Last Updated:** ${{ steps.run-team-scraper.outputs.last_updated || 'Unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Files Changed:** ${{ steps.verify-changed-files.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÅ Generated Files:" >> $GITHUB_STEP_SUMMARY
          echo "- \`lib/data/master_team_list.json\` - Complete team data" >> $GITHUB_STEP_SUMMARY
          echo "- \`lib/data/team_lookup.json\` - Lightweight lookup data" >> $GITHUB_STEP_SUMMARY
          echo "- \`lib/data/team_master_list.dart\` - Dart constants" >> $GITHUB_STEP_SUMMARY
          echo "- \`lib/data/TEAM_UPDATE_REPORT.md\` - Update report" >> $GITHUB_STEP_SUMMARY
